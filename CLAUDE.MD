在开发任何功能时，请遵循以下四个阶段进行。每个阶段都有明确的目标和需要维护的文件。每个阶段完成后，必须输出阶段总结并请求用户验收，只有用户明确确认后，才能进入下一阶段。

1. 概念层：可行性调研
目标：确定需求是否可行，识别技术难点和大致改动范围，不修改实际代码。
需要维护的文件：
plan.md：创建或更新该文件，记录以下内容：
需求描述
技术难点分析
可能的实现路径
需要验证的核心假设
验收要求：
输出调研总结，列出关键发现和推荐的下一步计划。
等待用户输入“确认”或明确同意后，方可进入骨架层。
2. 骨架层：最小可行性验证
目标：用最少的代码验证核心假设，确保关键路径能跑通，允许代码粗糙。
需要维护的文件：
plan.md：更新以下内容：
当前验证步骤
遇到的问题及解决方案
验证结果（成功/失败）
下一步完善方向
项目源码：进行最小改动，实现可运行的原型（代码可以临时、不追求质量）。
验收要求：
输出验证结果报告，说明核心假设是否成立，并展示可运行的 demo 效果。
等待用户手动测试并确认“验证通过”后，方可进入血肉层。
3. 血肉层：完善与规范
目标：基于已验证的骨架，按照项目规范完善代码（样式、封装、健壮性、注释、测试）。
需要维护的文件：
plan.md：作为任务清单，逐项标记完成情况（例如用 - [x]）。
项目源码：进行重构、优化、添加注释，确保符合项目代码风格。
测试文件（如适用）：编写或更新单元测试/集成测试。
package.json（如适用）：添加新依赖或脚本。
README.md：如果功能影响使用方式，添加简要说明。
验收要求：
输出完善后的代码和测试结果（如测试通过）。
等待用户审查代码并确认“符合要求”后，方可进入记忆固化层。
4. 记忆固化：记录技术决策
目标：将本次开发中确认的规则、技术选型、注意事项写入长期记忆，供未来参考。
需要维护的文件：
CLAUDE.md：在文件中追加一段结构化记录，包括：
功能名称与日期
关键技术决策（如启动时机、封装方式、避免的坑）
易错点与最佳实践
变更日志（changelog）：每次完成功能后，必须在 CLAUDE.md 的【变更日志】章节追加一条记录，格式为：
- 日期
- 需求描述
- 修改的文件及具体改动内容
plan.md：如果已完成使命，可将其归档（例如移动到 docs/archive/）或保留并标记为"已完成"。
验收要求：
输出追加到 CLAUDE.md 的内容预览。
等待用户确认记录准确无误后，整个功能开发流程结束。

---

## 变更日志

### 2026-02-19 新闻来源多样性优化

**需求：** Top 10 早报文章全部来自能源界，国家能源局、新华社等来源长期缺席。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/services/news_crawler.py` | 移除 `_crawl_one_source()` 中爬取后写入 SeenArticle 的逻辑；更新 docstring 步骤描述 |
| `backend/tasks/scheduler.py` | 在推送成功后（`html_snapshot` 非空）才将 Top N 文章写入 SeenArticle；将 `datetime` import 移至文件顶部 |
| `tests/test_crawler.py` | 更新 `test_saves_new_articles_to_db` 断言：`db.add_all` 不应再被调用 |

**验证结果：** ECS 实际推送后，新华社-能源频道 11 篇 + 能源界 4 篇，来源多样性正常。

---

---

## 功能记录：新闻来源多样性优化

**日期：** 2026-02-19

### 关键技术决策

**问题根源：** SeenArticle 最初设计为记录"已爬取"的文章 URL，导致更新慢的来源（国家能源局、新华社）的列表页文章被全部锁死，无法进入排名，早报 Top 10 全部来自更新快的能源界。

**采用方案：方案 C — SeenArticle 改为记录"已推送"**
- 爬取时不再写入 SeenArticle，改为推送成功后才写入
- 语义更准确：SeenArticle = "已推送过的文章"，而非"爬取过的文章"
- 改动文件：`backend/services/news_crawler.py`（移除爬取时写入逻辑）、`backend/tasks/scheduler.py`（推送后写入）

**放弃的方案：**
- 方案 A（基于发布时间过滤）：依赖 `published_at` 准确性，风险较高
- 方案 B（SeenArticle 定期清理）：治标不治本

### 易错点与最佳实践

1. **SeenArticle 的语义边界**：写入时机决定语义。"爬取后写入"会导致历史文章永久锁死；"推送后写入"才符合去重目的。
2. **更新频率不同的来源会相互竞争**：更新快的来源天然占据优势，需警惕某一来源长期垄断 Top 10。
3. **清理历史数据是必要步骤**：改变写入时机后，需确认旧的 SeenArticle 数据是否影响过渡期效果。
4. **测试要同步更新**：`test_crawler` 中对 SeenArticle 写入时机有断言，需随主逻辑一起修改（见提交 `e51a2f8`）。