在开发任何功能时，请遵循以下四个阶段进行。每个阶段都有明确的目标和需要维护的文件。每个阶段完成后，必须输出阶段总结并请求用户验收，只有用户明确确认后，才能进入下一阶段。

1. 概念层：可行性调研
目标：确定需求是否可行，识别技术难点和大致改动范围，不修改实际代码。
需要维护的文件：
plan.md：创建或更新该文件，记录以下内容：
需求描述
技术难点分析
可能的实现路径
需要验证的核心假设
验收要求：
输出调研总结，列出关键发现和推荐的下一步计划。
等待用户输入“确认”或明确同意后，方可进入骨架层。
2. 骨架层：最小可行性验证
目标：用最少的代码验证核心假设，确保关键路径能跑通，允许代码粗糙。
需要维护的文件：
plan.md：更新以下内容：
当前验证步骤
遇到的问题及解决方案
验证结果（成功/失败）
下一步完善方向
项目源码：进行最小改动，实现可运行的原型（代码可以临时、不追求质量）。
验收要求：
输出验证结果报告，说明核心假设是否成立，并展示可运行的 demo 效果。
等待用户手动测试并确认“验证通过”后，方可进入血肉层。
3. 血肉层：完善与规范
目标：基于已验证的骨架，按照项目规范完善代码（样式、封装、健壮性、注释、测试）。
需要维护的文件：
plan.md：作为任务清单，逐项标记完成情况（例如用 - [x]）。
项目源码：进行重构、优化、添加注释，确保符合项目代码风格。
测试文件（如适用）：编写或更新单元测试/集成测试。
package.json（如适用）：添加新依赖或脚本。
README.md：如果功能影响使用方式，添加简要说明。
验收要求：
输出完善后的代码和测试结果（如测试通过）。
等待用户审查代码并确认“符合要求”后，方可进入记忆固化层。
4. 记忆固化：记录技术决策
目标：将本次开发中确认的规则、技术选型、注意事项写入长期记忆，供未来参考。
需要维护的文件：
CLAUDE.md：在文件中追加一段结构化记录，包括：
功能名称与日期
关键技术决策（如启动时机、封装方式、避免的坑）
易错点与最佳实践
变更日志（changelog）：每次完成功能后，必须在 CLAUDE.md 的【变更日志】章节追加一条记录，格式为：
- 日期
- 需求描述
- 修改的文件及具体改动内容
plan.md：如果已完成使命，可将其归档（例如移动到 docs/archive/）或保留并标记为"已完成"。
验收要求：
输出追加到 CLAUDE.md 的内容预览。
等待用户确认记录准确无误后，整个功能开发流程结束。

---

## 功能记录：HTTPS 安全传输配置

**日期：** 2026-02-20

### 关键技术决策

**需求背景：** ECS 管理界面使用 HTTP 明文传输，存在安全风险：
- 管理员登录密码、SMTP 配置等敏感信息在网络中明文传输，可能被中间人截获
- 浏览器显示"不安全"警告，影响用户体验
- ECS 无域名，无法申请 Let's Encrypt 等受信任证书

**采用方案：自签名 SSL 证书 + HTTPS 强制跳转**
- 使用 OpenSSL 生成 RSA 2048 自签名证书（有效期 365 天）
- Nginx 配置 TLS 1.2/1.3 加密传输
- HTTP 强制跳转到 HTTPS（301 重定向）
- 提供证书自动续期脚本和健康检查脚本

**改动文件：**
- `nginx/conf.d/app.conf`：增加 HTTPS 监听（443 端口）、SSL 证书配置、HTTP 跳转
- `docker-compose.yml`：增加 443 端口映射、挂载 SSL 证书目录
- `ssl/`：新增 SSL 证书目录和说明文档
- `.gitignore`：排除证书文件（防止误提交敏感文件）
- `scripts/renew-ssl-cert.sh`：证书自动续期脚本
- `scripts/check-https.sh`：HTTPS 健康检查脚本
- `ARCHITECTURE.md`：新增 ADR-003（HTTPS 实现方案）、更新部署架构
- `README.md`：新增 HTTPS 访问说明、部署指南、证书续期和常见问题排查

### 易错点与最佳实践

1. **证书 CN 字段必须匹配访问 IP**：自签名证书的 CN（Common Name）应设置为 ECS 公网 IP，否则浏览器会显示域名不匹配错误。
2. **证书文件权限**：私钥文件（`.key`）应设置为 `600` 权限，防止未授权访问；证书文件不应提交到 Git。
3. **Docker 卷挂载**：证书目录必须挂载为只读（`:ro`），防止容器内误修改证书。
4. **443 端口必须开放**：ECS 安全组规则必须开放 443/TCP 端口，否则外部无法访问 HTTPS。
5. **HTTP 跳转配置**：必须保留 80 端口监听用于 HTTP 到 HTTPS 的 301 跳转，不能完全关闭 HTTP。
6. **证书有效期管理**：自签名证书有效期 365 天，建议设置 cron 定时任务提前 30 天自动续期。
7. **Nginx 重载而非重启**：续期证书后使用 `nginx -s reload` 而非 `docker restart`，避免服务中断。

### 验证结果

- **骨架层验证**：ECS 部署成功，HTTPS 访问正常，HTTP 自动跳转到 HTTPS ✅
- **血肉层完善**：文档完善、运维脚本创建、常见问题排查指南编写 ✅
- **加密强度**：TLS 1.2/1.3 + RSA 2048，与 Let's Encrypt 证书加密强度相同 ✅

---

## 变更日志

### 2026-02-20 HTTPS 安全传输配置

**需求：** 将 ECS 管理界面从 HTTP 升级为 HTTPS，防止敏感信息明文传输。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `nginx/conf.d/app.conf` | 新增 HTTPS 监听（443 端口）；配置 SSL 证书路径（`ssl_certificate`, `ssl_certificate_key`）；配置 TLS 1.2/1.3 安全参数；新增 HTTP 到 HTTPS 的 301 强制跳转 |
| `docker-compose.yml` | Nginx 容器增加 `443:443` 端口映射；挂载 SSL 证书目录：`./ssl:/etc/nginx/ssl:ro` |
| `ssl/README.md` | 新增 SSL 证书目录说明文档，包含证书生成命令和安全提示 |
| `.gitignore` | 排除 `ssl/*.{crt,key,pem}` 文件，防止证书误提交到 Git |
| `scripts/renew-ssl-cert.sh` | 证书自动续期脚本：备份旧证书 → 生成新证书 → 重启 Nginx → 清理 30 天前的备份 |
| `scripts/check-https.sh` | HTTPS 健康检查脚本：验证证书文件、有效期、容器状态、端口监听、HTTPS 访问、HTTP 跳转 |
| `ARCHITECTURE.md` | 新增 ADR-003（HTTPS 传输加密实现方案）；更新安全机制、运行环境、ECS 部署步骤、配置管理、架构演进记录 v1.1 |
| `README.md` | 新增「HTTPS 安全访问」章节（访问地址、证书警告处理、消除警告步骤）；新增「部署指南」章节（证书生成、443 端口开放、部署验证）；新增「证书续期」章节（手动续期、自动续期 cron）；新增「常见问题」章节（ERR_CONNECTION_REFUSED、ERR_CERT_AUTHORITY_INVALID、HTTP 不跳转排查） |
| `plan.md` | 记录概念层调研（方案对比、技术难点）、骨架层验证（部署步骤、验证结果）、血肉层完善（文档、脚本、任务清单） |

**验证结果：**
- ECS 部署成功：`https://8.155.155.125/admin` 可访问，HTTP 自动跳转到 HTTPS
- 加密强度：TLS 1.2/1.3 + RSA 2048
- 证书有效期：365 天（2026-02-20 至 2027-02-20）
- 运维脚本：证书续期脚本和健康检查脚本可正常运行

---

## 功能记录：英文新闻源接入 + 中文翻译推送

**日期：** 2026-02-19

### 关键技术决策

**需求背景：** 需要接入英文能源新闻网站（IEA News、Clean Energy Wire 等），并将英文标题和摘要翻译为中文后推送。

**采用方案：NewsSource 增加 language 字段**
- 数据库 schema 变更：`NewsSource` 增加 `language` 字段（默认 `zh`，可选 `en`）
- AI 摘要服务扩展：英文源时，一次 API 调用同时完成「标题翻译 + 内容摘要」，减少成本
- 爬虫逻辑调整：根据 `language` 字段触发翻译流程，中文源保持原逻辑不变
- Admin 后台：增加语言选择下拉框（中文/英文）

**改动文件：**
- `backend/models/news_source.py`：增加 `language` 字段
- `backend/database.py`：添加 `language` 列的迁移逻辑
- `backend/services/ai_summary.py`：扩展 `generate_summary_with_ai()`，支持英文翻译+摘要
- `backend/services/news_crawler.py`：传递 `language` 和 `original_title` 参数
- `backend/tasks/scheduler.py`：在 `source_dicts` 中传递 `language` 字段
- `backend/admin/views.py`：增加 `language` 字段配置

### 易错点与最佳实践

1. **AI prompt 设计**：必须明确要求输出格式（"第一行：中文标题，第二行：中文摘要，用 | 分隔"），否则返回格式不稳定。
2. **标题前缀清理**：IEA 等网站的标题包含分类标签（Coal、Electricity、Natural Gas 等），需在翻译后自动移除。
3. **正文长度阈值**：英文文章通常较短，需降低阈值（100→50 字符），避免误判为导航页。
4. **解析健壮性**：AI 返回可能无 `|` 分隔符或只有单行，需处理边界情况（按行分割、长度判断）。
5. **返回值变更**：`generate_summary_with_ai()` 从返回 `str` 改为 `tuple[str, str]`（标题, 摘要），需同步修改调用方。
6. **CSS 选择器**：不同网站结构差异大，需实际测试确认（如 IEA News 用 `article a`，不是 `a.m-article-card__link`）。

### 验证结果

- **骨架层验证**：ECS 推送测试，Top 10 全部来自 IEA News（英文源），标题和摘要均为中文 ✅
- **血肉层修复**：两轮优化后，10/10 标题完全翻译为中文，无残留英文前缀 ✅
- **测试覆盖**：本地测试套件 12/12 通过 ✅

---

## 变更日志

### 2026-02-19 英文新闻源接入 + 中文翻译推送

**需求：** 接入英文能源新闻网站（IEA News、Clean Energy Wire、EU Circular Economy Platform、Utility Dive、Circularise Blog），并将英文标题和摘要翻译为中文后推送。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/models/news_source.py` | 增加 `language` 字段（默认 `zh`） |
| `backend/database.py` | 添加 `ALTER TABLE` 迁移逻辑，自动添加 `language` 列 |
| `backend/services/ai_summary.py` | 扩展 `generate_summary_with_ai()`：新增 `source_language` 和 `original_title` 参数；英文源时一次调用返回翻译后的标题和摘要；增强 prompt 和解析逻辑；降低英文文章正文长度阈值（100→50 字符）；扩展前缀清理列表（包含 IEA 分类标签） |
| `backend/services/news_crawler.py` | 修改 `_fetch_article_summary()` 返回值为 `tuple[str, str]`；传递 `source_language` 和 `original_title` 参数；`_crawl_one_source()` 中提取 `language` 字段并传递；更新 docstring |
| `backend/tasks/scheduler.py` | 在 `source_dicts` 中添加 `language` 字段 |
| `backend/admin/views.py` | `NewsSourceView` 增加 `language` 字段（EnumField，中文/英文） |
| `README.md` | 新增「多语言新闻源支持」章节，说明如何添加英文源，推荐 4 个英文新闻源 |
| `tests/test_crawler.py` | 保持测试套件可运行（12/12 通过） |

**验证结果：** ECS 实际推送后，10/10 标题全部翻译为中文，英文源文章正常参与排名。

---

**需求：** Top 10 早报文章全部来自能源界，国家能源局、新华社等来源长期缺席。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/services/news_crawler.py` | 移除 `_crawl_one_source()` 中爬取后写入 SeenArticle 的逻辑；更新 docstring 步骤描述 |
| `backend/tasks/scheduler.py` | 在推送成功后（`html_snapshot` 非空）才将 Top N 文章写入 SeenArticle；将 `datetime` import 移至文件顶部 |
| `tests/test_crawler.py` | 更新 `test_saves_new_articles_to_db` 断言：`db.add_all` 不应再被调用 |

**验证结果：** ECS 实际推送后，新华社-能源频道 11 篇 + 能源界 4 篇，来源多样性正常。

---

---

## 功能记录：新闻来源多样性优化

**日期：** 2026-02-19

### 关键技术决策

**问题根源：** SeenArticle 最初设计为记录"已爬取"的文章 URL，导致更新慢的来源（国家能源局、新华社）的列表页文章被全部锁死，无法进入排名，早报 Top 10 全部来自更新快的能源界。

**采用方案：方案 C — SeenArticle 改为记录"已推送"**
- 爬取时不再写入 SeenArticle，改为推送成功后才写入
- 语义更准确：SeenArticle = "已推送过的文章"，而非"爬取过的文章"
- 改动文件：`backend/services/news_crawler.py`（移除爬取时写入逻辑）、`backend/tasks/scheduler.py`（推送后写入）

**放弃的方案：**
- 方案 A（基于发布时间过滤）：依赖 `published_at` 准确性，风险较高
- 方案 B（SeenArticle 定期清理）：治标不治本

### 易错点与最佳实践

1. **SeenArticle 的语义边界**：写入时机决定语义。"爬取后写入"会导致历史文章永久锁死；"推送后写入"才符合去重目的。
2. **更新频率不同的来源会相互竞争**：更新快的来源天然占据优势，需警惕某一来源长期垄断 Top 10。
3. **清理历史数据是必要步骤**：改变写入时机后，需确认旧的 SeenArticle 数据是否影响过渡期效果。
4. **测试要同步更新**：`test_crawler` 中对 SeenArticle 写入时机有断言，需随主逻辑一起修改（见提交 `e51a2f8`）。

## 五、架构文档（ARCHITECTURE.md）维护规范

`ARCHITECTURE.md` 是项目的核心架构文档，需始终保持与代码同步。它包含三个部分：

- **应用架构**：模块划分、组件关系、数据流、核心逻辑。
- **技术架构**：编程语言、框架、库、工具链及选型理由。
- **部署架构**：运行环境、构建方式、部署策略、配置管理。

### 维护时机与要求

在四阶段的每个阶段中，只要架构发生以下变化，就必须同步更新 `ARCHITECTURE.md`：

| 阶段 | 触发更新的典型情况 | 更新内容示例 |
|:----:|:-------------------|:-------------|
| **概念层** | 调研发现需要新增模块或调整模块边界 | 在“应用架构”中记录预期的模块变动 |
| **骨架层** | 最小验证后确定了模块的实际职责或交互方式 | 补充新增模块的描述，修正原有模块关系 |
| **血肉层** | 引入新的技术依赖、确定部署方案 | 在“技术架构”中记录选型理由；在“部署架构”中细化部署步骤 |
| **记忆固化** | 形成重要的架构原则或设计模式 | 在“应用架构”中追加架构决策记录（ADR） |

### 图示要求

为了让架构文档更直观，`ARCHITECTURE.md` 中的以下部分应使用 **Mermaid** 图示进行可视化表达：

- **应用架构**：使用 `graph TD` 或 `flowchart` 绘制模块关系图，展示核心模块及其依赖、数据流向。
- **技术架构**：可使用 `graph LR` 展示技术栈组件之间的关系（如前端、后端、数据库、第三方服务）。
- **部署架构**：使用 `graph TD` 或 `C4` 模型（简化版）描述部署拓扑，如客户端、服务器、CDN、云服务等。

#### 示例：应用架构图（Mermaid）

```mermaid
graph TD
    A[UI 渲染模块] --> B[事件处理模块]
    B --> C[游戏状态管理]
    C --> D[计时器模块]
    C --> E[地雷生成模块]
    F[初始化模块] --> C
    B --> G[右键标记模块]
    G --> C## 功能记录：晚报金融数据推送（时间戳 + 期货数据修复）

**日期：** 2026-02-20

### 关键技术决策

**需求背景：** 用户收到晚报邮件后发现两个问题：
1. 缺少大宗商品（期货）数据 - 原因是期货 API 失效
2. 所有金融信息都缺少时间戳 - 无法判断数据获取时间

**采用方案：添加时间戳 + 替换失效的期货 API**

#### 1. 时间戳功能实现

**数据结构扩展：**
```python
@dataclass
class FinanceQuote:
    name: str
    symbol: str
    price: float
    change_pct: float
    item_type: str
    timestamp: datetime  # 新增：数据获取时间
```

**实现要点：**
- 在 `_fetch_stock_a()`, `_fetch_stock_hk()`, `_fetch_futures()` 三个函数中，所有返回的 `FinanceQuote` 都添加 `timestamp=datetime.now()`
- 邮件模板新增「数据时间」列，格式为 `HH:MM:SS`（如 15:03:50）
- 时间戳样式：`font-size: 12px; color: #999;`（灰色小字）

#### 2. 期货 API 修复

**问题根源：** AKShare 1.18.25 的 `futures_zh_spot()` API 存在严重 Bug：
```
ValueError: Length mismatch: Expected axis has 1 elements, new values have 44 elements
```

**根本原因：** 新浪财经期货数据源结构发生变化，AKShare 未及时适配

**解决方案：** 使用 `futures_global_spot_em()` API 替代

**新实现要点：**
```python
def _fetch_futures(symbol: str, name: str) -> FinanceQuote | None:
    """
    获取大宗商品/期货现货价格
    
    注意：由于 AKShare 的 futures_zh_spot() API 存在 Bug，
    改用 futures_global_spot_em() 获取全球现货数据（620 个商品）。
    """
    df = ak.futures_global_spot_em()
    
    # 智能匹配逻辑：
    # 1. 优先按代码精确匹配（如 LCPT, LALT）
    # 2. 按名称关键词模糊匹配（铜/Copper/Cu, 铝/Aluminum/Al）
    # 3. 优先选择"综合"品种（主力品种）
```

**商品代码映射：**
- `cu2505` (沪铜期货) → 综合铜03 (LCPT)
- `al2505` (沪铝期货) → 综合铝03 (LALT)
- `lc2506` (碳酸锂期货) → ❌ 数据不可用（价格为 NaN）

**改动文件：**
- `backend/services/finance_crawler.py`：添加 `timestamp` 字段、重写 `_fetch_futures()`、添加详细注释
- `backend/templates/email_evening.html`：添加时间戳列到股票和期货表格
- `scripts/setup_finance_items.py`：更新为 5 个数据项（暂时移除碳酸锂）
- `README.md`：新增「晚报金融数据推送」完整章节

### 易错点与最佳实践

1. **期货合约代码的动态性**：期货合约有到期日（如 cu2505 表示 2025年5月交割），需定期手动更新为当前主力合约。建议每季度检查一次。

2. **AKShare API 的不稳定性**：`futures_zh_spot()` 失效后改用 `futures_global_spot_em()`，但后者的锂相关品种价格返回 NaN。**教训**：依赖开源库时需要备用方案。

3. **时间戳字段是必需的**：金融数据的时效性至关重要，用户需要知道数据获取时间。即使骨架层代码粗糙，也必须包含时间戳字段。

4. **数据精度统一**：价格和涨跌幅必须统一保留 2 位小数，使用 `round(value, 2)` 确保格式一致。

5. **邮件模板的时间格式**：使用 `strftime('%H:%M:%S')` 而非完整日期时间，节省邮件空间且更易读。

6. **期货数据源的智能匹配**：由于期货合约代码（cu2505）与现货代码（LCPT）不同，需要实现关键词匹配逻辑：
   - 提取合约类型（如 cu → 铜）
   - 搜索包含关键词的商品（铜/Copper/Cu）
   - 优先选择"综合"品种（主力合约）

7. **价格有效性检查**：必须检查价格是否为 NaN 或 0，避免推送无效数据。

### 验证结果

- **骨架层验证**：ECS 测试成功，5/6 数据项获取成功（3 股票 + 2 期货），时间戳正常 ✅
- **血肉层完善**：邮件模板优化、文档完善、ECS 部署验证 ✅
- **实际推送效果**：晚报推送成功，邮件格式正确，数据精度符合要求 ✅

### 碳酸锂数据问题

**现状：** `futures_global_spot_em()` API 中虽有氢氧化锂（LTH00Y）等锂相关品种，但价格字段返回 NaN，无法获取有效数据。

**已验证方案：**
- `futures_zh_spot()`：失败（Length mismatch 错误）
- `futures_global_spot_em()`：部分成功（铜铝可用，锂 NaN）

**待验证方案：**
- 第三方 API（Tushare、JoinQuant）- 需注册和付费
- 期货交易所官方数据（广期所 API）- 需调研接口
- 现货价格平台（生意社、卓创资讯）- 需爬虫或付费 API

**暂时方案：** 维持 5 个数据项（3 股票 + 2 期货），碳酸锂数据留待后续有强需求时再调研。

---

### 2026-02-20 晚报金融数据推送（时间戳 + 期货数据修复）

**需求：** 用户收到晚报邮件后发现：1) 缺少大宗商品（期货）数据；2) 所有金融信息都缺少时间戳。需要在骨架层立即解决这两个问题。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/services/finance_crawler.py` | 添加 `from datetime import datetime`；`FinanceQuote` 数据类新增 `timestamp: datetime` 字段；`_fetch_stock_a()`、`_fetch_stock_hk()`、`_fetch_futures()` 三个函数返回时添加 `timestamp=datetime.now()`；重写 `_fetch_futures()` 函数：放弃失效的 `futures_zh_spot()` API，改用 `futures_global_spot_em()` 获取全球商品现货数据（620个商品）；实现智能匹配逻辑：优先按代码精确匹配（如 LCPT, LALT），其次按名称关键词模糊匹配（铜/Copper/Cu, 铝/Aluminum/Al），优先选择"综合"品种（主力品种）；添加价格有效性检查（过滤 NaN 和 0）；添加详细注释和错误日志 |
| `backend/templates/email_evening.html` | 股票表格新增「数据时间」列（`<th>数据时间</th>`）；期货表格新增「数据时间」列；时间戳单元格样式：`style="font-size: 12px; color: #999;"`；时间格式：`{{ q.timestamp.strftime('%H:%M:%S') }}`（仅显示时:分:秒） |
| `scripts/setup_finance_items.py` | 更新金融数据项配置为 5 个（3 股票 + 2 期货）：阳光电源（300274）、宁德时代（300750）、隆基绿能（601012）、沪铜主力（cu2505）、沪铝主力（al2505）；移除碳酸锂（lc2506）并添加注释说明原因（价格为 NaN，暂不可用）；添加未来解决方案建议（交易所官方API、现货价格平台） |
| `scripts/test_new_futures_impl.py` | 创建新的测试脚本，验证 5 个金融数据项的获取：测试 A 股数据（3个）、测试期货数据（2个）、验证时间戳字段、验证数据格式（2位小数）；输出分类展示（股票、期货） |
| `scripts/test_push_simple.py` | 创建简化的晚报推送测试脚本：直接调用 `run_evening_push(1, triggered_by="manual_test")`，用于快速验证推送功能 |
| `README.md` | 新增「晚报金融数据推送」完整章节：功能特性（A股、期货、时间戳、数据精度、自动推送）；配置金融数据项步骤（Admin 后台 + 脚本批量配置）；数据示例（表格展示邮件效果）；支持的金融数据类型对照表（A股、港股、期货及对应API）；注意事项（期货合约代码需定期更新、碳酸锂暂不可用） |
| `plan.md` | 记录完整的四阶段开发过程：概念层（技术难点分析、方案对比）、骨架层（Bug修复、API验证、ECS测试）、血肉层（代码完善、邮件模板优化、文档更新）、验收总结（修改文件清单、实际推送效果、遗留问题） |

**验证结果：**
- ECS 测试成功：5/5 数据项获取成功（3 股票 + 2 期货）
- 时间戳功能：所有数据包含获取时间，邮件展示格式正确（HH:MM:SS）
- 数据精度：价格和涨跌幅均保留 2 位小数
- 晚报推送：手动触发成功，邮件发送正常
- 遗留问题：碳酸锂数据暂不可用（AKShare API 返回 NaN），留待后续调研

---

## 六、定期复盘与持续优化

### 复盘触发机制

为了持续提升开发效率和成本控制，建立定期复盘机制。触发复盘的条件包括：

| 触发条件 | 复盘范围 | 输出文档 |
|---------|---------|----------|
| **完成重要功能**（架构变更、多文件改动） | 回顾本次开发全流程 | `docs/retrospective-YYYY-MM-DD.md` |
| **Token 消耗超过 100k** | 分析成本浪费点 | 追加到当前复盘文档 |
| **开发耗时超过 2 小时** | 分析时间浪费点 | 追加到当前复盘文档 |
| **月度总结**（每月最后一天） | 统计全月数据，识别系统性问题 | `docs/monthly-review-YYYY-MM.md` |

### 复盘分析维度

每次复盘应包含以下分析：

1. **时间分布分析**
   - 四阶段耗时占比（概念层 / 骨架层 / 血肉层 / 记忆固化）
   - 识别耗时异常的阶段（如骨架层 > 50%）

2. **Token 消耗分析**
   - 按类型分类（文件读取 / Bash 输出 / 工具调用 / 系统提示 / 对话内容）
   - 识别浪费点（重复读取、冗余输出、过度验证）

3. **流程瓶颈识别**
   - 阶段划分是否合理
   - 阶段确认是否过于频繁
   - 文档维护是否过于详细

4. **技术问题识别**
   - SSH/网络连接不稳定
   - Docker 重复重建
   - 测试输出冗余
   - 文件读取效率低

5. **优化方案提出**
   - 流程优化（快速模式、标准模式、完整模式）
   - 技术优化（本地开发、批量执行、输出过滤）
   - 成本优化（模型分级、缓存策略）

### 复盘输出规范

复盘文档应包含以下章节：

```markdown
# [功能名称] 开发复盘与优化方案

**日期：** YYYY-MM-DD
**案例：** [具体功能描述]
**总耗时：** X 小时
**Token 消耗：** Xk / 200k (X%)

## 一、开发过程分析
### 1.1 时间分布
### 1.2 Token 消耗分析

## 二、速度瓶颈分析
### 2.1 流程层面的问题
### 2.2 技术层面的问题

## 三、成本浪费分析
### 3.1 Token 浪费点
### 3.2 时间浪费点

## 四、根本原因总结

## 五、优化方案
### 5.1 流程优化
### 5.2 技术优化
### 5.3 文档优化
### 5.4 成本优化

## 六、预期收益总结

## 七、行动计划
```

### 首次复盘：2026-02-20（晚报金融数据推送功能）

**完整复盘文档：** `docs/retrospective-2026-02-20.md`

#### 核心发现

**时间与成本数据：**
- **总耗时：** 180 分钟（3 小时）
- **Token 消耗：** 112k / 200k（56%）
- **最大瓶颈：** 骨架层耗时 120 分钟（67%）
- **总浪费：** 时间 105 分钟（58%），Token 36k（32%）

**主要浪费点：**
- 骨架层过度验证（应快速验证，实际做了大量调试）
- SSH 连接重试（15+ 次失败，浪费 20 分钟 + 5k tokens）
- Docker 重复重建（6 次，浪费 15 分钟）
- plan.md 反复读取（10+ 次，浪费 8k tokens）
- AKShare 进度条冗余输出（浪费 8k tokens）

#### 优化方案总结

**1. 三模式分级开发体系**

| 模式 | 适用场景 | 流程 | 预期收益 |
|------|---------|------|----------|
| **快速模式** | < 30 分钟任务（Bug修复、文档更新） | 直接实现 → 本地测试 → Git 提交 | 时间节省 60%，Token 节省 70% |
| **标准模式** | 30-120 分钟任务（新功能、功能增强） | 快速调研 → 骨架+血肉合并 → 记忆固化 | 时间节省 50%，Token 节省 50% |
| **完整模式** | > 120 分钟任务（架构变更、复杂功能） | 保持完整四阶段 | 保持严谨性，风险可控 |

**2. 技术优化清单**

| 优化项 | 方法 | 预期收益 |
|--------|------|----------|
| **本地开发环境** ⭐⭐⭐ | 创建 `docker-compose.dev.yml`，代码卷挂载 | SSH 次数减少 80%，节省 15 分钟 |
| **批量 SSH 执行** ⭐⭐⭐ | 使用 heredoc 批量执行命令 | SSH 连接次数减少 70%，节省 15 分钟 |
| **过滤冗余输出** ⭐⭐ | 禁用进度条（`TQDM_DISABLE=1`），grep 过滤 | Token 节省 8k |
| **精简 plan.md** ⭐⭐ | 只记录关键决策、任务清单、验收标准 | 维护时间节省 75%，Token 节省 6k |
| **智能文件读取** ⭐ | 使用 offset/limit 增量读取，避免重复完整读取 | Token 节省 8k |

**3. 预期收益**

如应用优化方案，本次晚报功能开发的效果：

| 指标 | 原耗时/成本 | 优化后 | 节省 |
|------|-----------|--------|------|
| 开发时间 | 180 分钟 | 60 分钟 | **67%** |
| Token 消耗 | 112k | 35k | **69%** |

假设每月开发 10 小功能 + 3 中功能 + 1 大功能：
- **时间节省：** 27 小时/月（**56%**）
- **成本节省：** 1110k tokens/月（**61%**）

#### 待执行优化（优先级排序）

**本周行动计划（2026-02-20 ~ 2026-02-26）：**

- [ ] **Day 1**：创建本地开发环境（`docker-compose.dev.yml`）⭐⭐⭐
- [ ] **Day 2**：创建 ECS 批量部署脚本（`scripts/deploy-to-ecs.sh`）⭐⭐⭐
- [ ] **Day 3**：优化测试输出（禁用 AKShare 进度条）⭐⭐
- [ ] **Day 4**：创建精简版 plan.md 模板 ⭐⭐
- [ ] **Day 5**：更新 CLAUDE.md，添加三模式开发规范 ⭐⭐

**验证标准（下次开发时检验）：**
- [ ] 本地开发环境可用，无需频繁部署 ECS
- [ ] SSH 连接次数减少 70%
- [ ] Token 消耗减少 50%
- [ ] 开发时间缩短 50%

---
