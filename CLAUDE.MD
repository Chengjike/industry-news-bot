在开发任何功能时，请遵循以下四个阶段进行。每个阶段都有明确的目标和需要维护的文件。每个阶段完成后，必须输出阶段总结并请求用户验收，只有用户明确确认后，才能进入下一阶段。

1. 概念层：可行性调研
目标：确定需求是否可行，识别技术难点和大致改动范围，不修改实际代码。
需要维护的文件：
plan.md：创建或更新该文件，记录以下内容：
需求描述
技术难点分析
可能的实现路径
需要验证的核心假设
验收要求：
输出调研总结，列出关键发现和推荐的下一步计划。
等待用户输入“确认”或明确同意后，方可进入骨架层。
2. 骨架层：最小可行性验证
目标：用最少的代码验证核心假设，确保关键路径能跑通，允许代码粗糙。
需要维护的文件：
plan.md：更新以下内容：
当前验证步骤
遇到的问题及解决方案
验证结果（成功/失败）
下一步完善方向
项目源码：进行最小改动，实现可运行的原型（代码可以临时、不追求质量）。
验收要求：
输出验证结果报告，说明核心假设是否成立，并展示可运行的 demo 效果。
等待用户手动测试并确认“验证通过”后，方可进入血肉层。
3. 血肉层：完善与规范
目标：基于已验证的骨架，按照项目规范完善代码（样式、封装、健壮性、注释、测试）。
需要维护的文件：
plan.md：作为任务清单，逐项标记完成情况（例如用 - [x]）。
项目源码：进行重构、优化、添加注释，确保符合项目代码风格。
测试文件（如适用）：编写或更新单元测试/集成测试。
package.json（如适用）：添加新依赖或脚本。
README.md：如果功能影响使用方式，添加简要说明。
验收要求：
输出完善后的代码和测试结果（如测试通过）。
等待用户审查代码并确认“符合要求”后，方可进入记忆固化层。
4. 记忆固化：记录技术决策
目标：将本次开发中确认的规则、技术选型、注意事项写入长期记忆，供未来参考。
需要维护的文件：
CLAUDE.md：在文件中追加一段结构化记录，包括：
功能名称与日期
关键技术决策（如启动时机、封装方式、避免的坑）
易错点与最佳实践
变更日志（changelog）：每次完成功能后，必须在 CLAUDE.md 的【变更日志】章节追加一条记录，格式为：
- 日期
- 需求描述
- 修改的文件及具体改动内容
plan.md：如果已完成使命，可将其归档（例如移动到 docs/archive/）或保留并标记为"已完成"。
验收要求：
输出追加到 CLAUDE.md 的内容预览。
等待用户确认记录准确无误后，整个功能开发流程结束。

---

## 功能记录：英文新闻源接入 + 中文翻译推送

**日期：** 2026-02-19

### 关键技术决策

**需求背景：** 需要接入英文能源新闻网站（IEA News、Clean Energy Wire 等），并将英文标题和摘要翻译为中文后推送。

**采用方案：NewsSource 增加 language 字段**
- 数据库 schema 变更：`NewsSource` 增加 `language` 字段（默认 `zh`，可选 `en`）
- AI 摘要服务扩展：英文源时，一次 API 调用同时完成「标题翻译 + 内容摘要」，减少成本
- 爬虫逻辑调整：根据 `language` 字段触发翻译流程，中文源保持原逻辑不变
- Admin 后台：增加语言选择下拉框（中文/英文）

**改动文件：**
- `backend/models/news_source.py`：增加 `language` 字段
- `backend/database.py`：添加 `language` 列的迁移逻辑
- `backend/services/ai_summary.py`：扩展 `generate_summary_with_ai()`，支持英文翻译+摘要
- `backend/services/news_crawler.py`：传递 `language` 和 `original_title` 参数
- `backend/tasks/scheduler.py`：在 `source_dicts` 中传递 `language` 字段
- `backend/admin/views.py`：增加 `language` 字段配置

### 易错点与最佳实践

1. **AI prompt 设计**：必须明确要求输出格式（"第一行：中文标题，第二行：中文摘要，用 | 分隔"），否则返回格式不稳定。
2. **标题前缀清理**：IEA 等网站的标题包含分类标签（Coal、Electricity、Natural Gas 等），需在翻译后自动移除。
3. **正文长度阈值**：英文文章通常较短，需降低阈值（100→50 字符），避免误判为导航页。
4. **解析健壮性**：AI 返回可能无 `|` 分隔符或只有单行，需处理边界情况（按行分割、长度判断）。
5. **返回值变更**：`generate_summary_with_ai()` 从返回 `str` 改为 `tuple[str, str]`（标题, 摘要），需同步修改调用方。
6. **CSS 选择器**：不同网站结构差异大，需实际测试确认（如 IEA News 用 `article a`，不是 `a.m-article-card__link`）。

### 验证结果

- **骨架层验证**：ECS 推送测试，Top 10 全部来自 IEA News（英文源），标题和摘要均为中文 ✅
- **血肉层修复**：两轮优化后，10/10 标题完全翻译为中文，无残留英文前缀 ✅
- **测试覆盖**：本地测试套件 12/12 通过 ✅

---

## 变更日志

### 2026-02-19 英文新闻源接入 + 中文翻译推送

**需求：** 接入英文能源新闻网站（IEA News、Clean Energy Wire、EU Circular Economy Platform、Utility Dive、Circularise Blog），并将英文标题和摘要翻译为中文后推送。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/models/news_source.py` | 增加 `language` 字段（默认 `zh`） |
| `backend/database.py` | 添加 `ALTER TABLE` 迁移逻辑，自动添加 `language` 列 |
| `backend/services/ai_summary.py` | 扩展 `generate_summary_with_ai()`：新增 `source_language` 和 `original_title` 参数；英文源时一次调用返回翻译后的标题和摘要；增强 prompt 和解析逻辑；降低英文文章正文长度阈值（100→50 字符）；扩展前缀清理列表（包含 IEA 分类标签） |
| `backend/services/news_crawler.py` | 修改 `_fetch_article_summary()` 返回值为 `tuple[str, str]`；传递 `source_language` 和 `original_title` 参数；`_crawl_one_source()` 中提取 `language` 字段并传递；更新 docstring |
| `backend/tasks/scheduler.py` | 在 `source_dicts` 中添加 `language` 字段 |
| `backend/admin/views.py` | `NewsSourceView` 增加 `language` 字段（EnumField，中文/英文） |
| `README.md` | 新增「多语言新闻源支持」章节，说明如何添加英文源，推荐 4 个英文新闻源 |
| `tests/test_crawler.py` | 保持测试套件可运行（12/12 通过） |

**验证结果：** ECS 实际推送后，10/10 标题全部翻译为中文，英文源文章正常参与排名。

---

**需求：** Top 10 早报文章全部来自能源界，国家能源局、新华社等来源长期缺席。

**修改内容：**

| 文件 | 改动 |
|------|------|
| `backend/services/news_crawler.py` | 移除 `_crawl_one_source()` 中爬取后写入 SeenArticle 的逻辑；更新 docstring 步骤描述 |
| `backend/tasks/scheduler.py` | 在推送成功后（`html_snapshot` 非空）才将 Top N 文章写入 SeenArticle；将 `datetime` import 移至文件顶部 |
| `tests/test_crawler.py` | 更新 `test_saves_new_articles_to_db` 断言：`db.add_all` 不应再被调用 |

**验证结果：** ECS 实际推送后，新华社-能源频道 11 篇 + 能源界 4 篇，来源多样性正常。

---

---

## 功能记录：新闻来源多样性优化

**日期：** 2026-02-19

### 关键技术决策

**问题根源：** SeenArticle 最初设计为记录"已爬取"的文章 URL，导致更新慢的来源（国家能源局、新华社）的列表页文章被全部锁死，无法进入排名，早报 Top 10 全部来自更新快的能源界。

**采用方案：方案 C — SeenArticle 改为记录"已推送"**
- 爬取时不再写入 SeenArticle，改为推送成功后才写入
- 语义更准确：SeenArticle = "已推送过的文章"，而非"爬取过的文章"
- 改动文件：`backend/services/news_crawler.py`（移除爬取时写入逻辑）、`backend/tasks/scheduler.py`（推送后写入）

**放弃的方案：**
- 方案 A（基于发布时间过滤）：依赖 `published_at` 准确性，风险较高
- 方案 B（SeenArticle 定期清理）：治标不治本

### 易错点与最佳实践

1. **SeenArticle 的语义边界**：写入时机决定语义。"爬取后写入"会导致历史文章永久锁死；"推送后写入"才符合去重目的。
2. **更新频率不同的来源会相互竞争**：更新快的来源天然占据优势，需警惕某一来源长期垄断 Top 10。
3. **清理历史数据是必要步骤**：改变写入时机后，需确认旧的 SeenArticle 数据是否影响过渡期效果。
4. **测试要同步更新**：`test_crawler` 中对 SeenArticle 写入时机有断言，需随主逻辑一起修改（见提交 `e51a2f8`）。

## 五、架构文档（ARCHITECTURE.md）维护规范

`ARCHITECTURE.md` 是项目的核心架构文档，需始终保持与代码同步。它包含三个部分：

- **应用架构**：模块划分、组件关系、数据流、核心逻辑。
- **技术架构**：编程语言、框架、库、工具链及选型理由。
- **部署架构**：运行环境、构建方式、部署策略、配置管理。

### 维护时机与要求

在四阶段的每个阶段中，只要架构发生以下变化，就必须同步更新 `ARCHITECTURE.md`：

| 阶段 | 触发更新的典型情况 | 更新内容示例 |
|:----:|:-------------------|:-------------|
| **概念层** | 调研发现需要新增模块或调整模块边界 | 在“应用架构”中记录预期的模块变动 |
| **骨架层** | 最小验证后确定了模块的实际职责或交互方式 | 补充新增模块的描述，修正原有模块关系 |
| **血肉层** | 引入新的技术依赖、确定部署方案 | 在“技术架构”中记录选型理由；在“部署架构”中细化部署步骤 |
| **记忆固化** | 形成重要的架构原则或设计模式 | 在“应用架构”中追加架构决策记录（ADR） |

### 图示要求

为了让架构文档更直观，`ARCHITECTURE.md` 中的以下部分应使用 **Mermaid** 图示进行可视化表达：

- **应用架构**：使用 `graph TD` 或 `flowchart` 绘制模块关系图，展示核心模块及其依赖、数据流向。
- **技术架构**：可使用 `graph LR` 展示技术栈组件之间的关系（如前端、后端、数据库、第三方服务）。
- **部署架构**：使用 `graph TD` 或 `C4` 模型（简化版）描述部署拓扑，如客户端、服务器、CDN、云服务等。

#### 示例：应用架构图（Mermaid）

```mermaid
graph TD
    A[UI 渲染模块] --> B[事件处理模块]
    B --> C[游戏状态管理]
    C --> D[计时器模块]
    C --> E[地雷生成模块]
    F[初始化模块] --> C
    B --> G[右键标记模块]
    G --> C