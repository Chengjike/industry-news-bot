# 定期会议纪要

## 会议基本信息

**会议时间：** 2026-02-24
**会议主题：** 行业新闻机器人项目架构评审与AKShare数据源问题专项分析
**主持人：** ARCH（架构师）
**参会人员：** 后端开发（张工）、前端开发（李工）、运维工程师（王工）、安全工程师（赵工）、产品经理（孙经理）
**会议类型：** 技术架构评审 + 问题专项分析

---

## 第一部分：架构全面评审会议纪要

### 1. 项目现状回顾

**当前状态：**
- ✅ 核心功能已上线：早报（9:00）+ 晚报（18:00）双推送
- ✅ 多行业支持：独立配置新闻源、金融数据、收件人
- ✅ Web管理后台：完整CRUD操作，实时监控
- ✅ 容器化部署：Docker + Nginx，生产就绪配置

**技术栈概览：**
- **后端**：FastAPI + SQLAlchemy + SQLite
- **前端管理**：Starlette Admin（自动生成）
- **调度**：APScheduler（定时任务）
- **数据源**：AKShare（金融数据）+ 网络爬虫
- **AI服务**：阿里云通义千问（摘要生成）
- **部署**：Docker Compose + Nginx + 自签名HTTPS

### 2. 各角色评审意见汇总

#### 🛠️ 后端开发 - 张工
**应用架构合理性：**
- ✅ 分层清晰：models/services/tasks/utils分离明确
- ✅ 异步架构：FastAPI + httpx异步爬取，适合I/O密集型场景
- ✅ 模块化设计：各服务独立，耦合度低

**主要问题：**
1. ⚠️ **数据库选型**：SQLite适合原型，但生产环境需要更稳定方案
2. ⚠️ **AKShare稳定性**：期货数据API存在Bug，需要应急方案
3. ⚠️ **测试覆盖不足**：单元测试不完整，集成测试缺失

#### 🎨 前端开发 - 李工
**管理界面评估：**
- ✅ 功能完整：Starlette Admin自动生成CRUD
- ✅ 响应式设计：移动端适配良好
- ✅ 表单验证：数据校验完善

**用户体验问题：**
1. ⚠️ **SSL证书警告**：自签名证书导致浏览器红色警告
2. ⚠️ **界面功能单一**：缺乏数据可视化图表
3. ⚠️ **移动端优化不足**：无移动App或PWA支持

#### 🚀 运维工程师 - 王工
**部署架构评估：**
- ✅ 容器化标准：Docker Compose配置规范
- ✅ 资源管理：CPU/内存限制合理
- ✅ 健康检查：自动健康监控机制

**运维风险：**
1. ⚠️ **单点故障**：单容器部署，无高可用
2. ⚠️ **监控告警缺失**：无性能指标收集和告警
3. ⚠️ **备份恢复不完善**：SQLite文件备份策略缺失

#### 🔒 安全工程师 - 赵工
**安全机制评估：**
- ✅ 基础安全：SSRF防护、输入验证、日志脱敏
- ✅ 加密存储：Fernet加密敏感数据
- ✅ 安全响应头：CSP、HSTS配置完整

**安全漏洞：**
1. ⚠️ **认证机制薄弱**：单因素密码认证，无多因素认证
2. ⚠️ **API安全风险**：管理API无认证保护，无速率限制
3. ⚠️ **证书管理风险**：自签名证书需手动信任

#### 📊 产品经理 - 孙经理
**产品功能评估：**
- ✅ 核心价值：行业新闻+金融数据双推送
- ✅ 多行业支持：灵活配置，扩展性强
- ✅ 管理便捷：Web后台操作简单

**产品体验问题：**
1. ⚠️ **推送渠道单一**：仅邮件推送，用户触达有限
2. ⚠️ **个性化不足**：用户无法自定义关键词偏好
3. ⚠️ **数据分析缺失**：无推送效果分析

### 3. 问题优先级分类

#### 🔴 高优先级问题（直接影响稳定运行）
1. **AKShare数据源稳定性**：期货API Bug导致晚报数据缺失
2. **SSL证书警告**：自签名证书影响用户体验和信任
3. **单点故障风险**：单容器部署无高可用
4. **数据库可靠性**：SQLite生产环境风险

#### 🟡 中优先级问题（影响扩展和维护）
1. **监控告警缺失**：无性能指标和故障告警
2. **测试覆盖不足**：代码质量保障不完善
3. **认证机制薄弱**：单因素密码安全风险
4. **备份恢复不完善**：数据丢失风险

#### 🟢 低优先级问题（功能增强）
1. **推送渠道单一**：仅支持邮件
2. **界面功能简单**：缺乏数据可视化
3. **个性化不足**：用户无法自定义
4. **移动体验不佳**：无移动优化

### 4. 技术债务清单

| 类别 | 具体问题 | 影响程度 | 预估工作量 |
|------|----------|----------|------------|
| 数据源 | AKShare API Bug | 高（晚报数据缺失） | 2-3人天 |
| 安全 | 自签名SSL证书 | 高（用户体验差） | 1-2人天 |
| 架构 | 单点故障风险 | 高（服务中断） | 3-5人天 |
| 数据库 | SQLite生产限制 | 中（扩展性差） | 5-7人天 |
| 监控 | 无性能监控 | 中（故障难发现） | 3-4人天 |
| 测试 | 测试覆盖不足 | 中（代码质量风险） | 4-6人天 |
| 认证 | 单因素认证 | 中（安全风险） | 2-3人天 |
| 功能 | 推送渠道单一 | 低（功能局限） | 5-8人天 |

### 5. 改进方向建议

#### 短期优化（1-2周）
1. **解决AKShare问题**：修复期货数据API，添加备用数据源
2. **SSL证书升级**：申请Let's Encrypt证书，自动续期
3. **基础监控添加**：基础性能指标收集和告警

#### 中期改进（1-2月）
1. **数据库迁移**：SQLite → PostgreSQL，添加迁移工具
2. **高可用改造**：多实例部署，负载均衡
3. **测试体系完善**：单元测试+集成测试+压力测试
4. **安全加固**：多因素认证，API安全增强

#### 长期规划（3-6月）
1. **推送渠道扩展**：微信/钉钉集成
2. **数据分析平台**：推送效果分析，用户行为洞察
3. **移动端优化**：PWA或原生App
4. **智能化升级**：个性化推荐，智能摘要优化

---

## 第二部分：AKShare数据源问题专项分析纪要

### 问题概述

**核心问题：** AKShare 1.18.25的`futures_zh_spot()` API存在严重Bug，导致无法获取中国期货数据（沪铜、沪铝、碳酸锂期货）。

**错误信息：**
```
ValueError: Length mismatch: Expected axis has 1 elements, new values have 44 elements
```

**影响范围：** 晚报推送中的金融数据部分，期货数据缺失或数据不准确。

### 根本原因分析

#### 1. API接口Bug
- **AKShare版本：** 1.18.25
- **问题API：** `ak.futures_zh_spot(symbol, market="CF")`
- **根本原因：** 新浪财经期货数据源结构发生变化，AKShare未及时适配

#### 2. 当前临时方案评估
```python
# 当前实现（使用全球现货数据）
df = ak.futures_global_spot_em()
```

**问题：**
- ✅ 数据可用：返回620个全球商品现货数据
- ❌ **数据不匹配**：全球现货价格 ≠ 中国期货价格
- ❌ **时间不一致**：现货数据非实时，期货数据有交易时间
- ❌ **品种差异**：全球铜价 ≠ 沪铜期货价格

### 候选数据源调研

#### 1. **Tushare Pro**（推荐指数：⭐⭐⭐⭐⭐）
- 专业金融数据API，覆盖A股、期货、基金等
- 数据质量高，官方维护
- 免费版有频率限制（2000积分/天）

#### 2. **JoinQuant**（聚宽）（推荐指数：⭐⭐⭐⭐）
- 量化交易平台，提供丰富金融数据
- 支持实时行情和历史数据
- 免费额度较充足

#### 3. **Baostock**（推荐指数：⭐⭐⭐）
- 开源免费A股数据
- 仅A股数据，无期货

#### 4. **Eastmoney**（东方财富API）（推荐指数：⭐⭐⭐）
- 免费，数据较全面
- 非官方API，可能变更

#### 5. **QStock**（推荐指数：⭐⭐）
- 基于多种数据源的Python库
- 依赖底层数据源稳定性

### 多数据源架构设计方案

#### 架构目标：
1. **高可用性**：任一数据源故障不影响服务
2. **数据质量**：选择最准确的数据源
3. **成本优化**：优先使用免费/低成本方案
4. **可扩展性**：易于添加新数据源

#### 核心组件设计：
```python
# 数据源抽象层
class DataSource(ABC):
    @abstractmethod
    def fetch_stock_a(self, symbol: str) -> Optional[FinanceQuote]:
        pass

    @abstractmethod
    def fetch_futures(self, symbol: str) -> Optional[FinanceQuote]:
        pass

    @abstractmethod
    def health_check(self) -> bool:
        pass

# 数据源管理器
class DataSourceManager:
    def __init__(self):
        self.sources: List[DataSource] = []
        self.source_stats: Dict[str, dict] = {}  # 成功率统计
```

#### 数据源优先级策略：

| 优先级 | 数据源 | 适用场景 | 优势 |
|--------|--------|----------|------|
| 1 | AKShare (修复后) | 主要数据源 | 免费、全面 |
| 2 | Tushare Pro | 备用/补充 | 数据质量高 |
| 3 | JoinQuant | 期货补充 | 实时性好 |
| 4 | Eastmoney | 应急降级 | 免费可用 |
| 5 | Global Spot (当前) | 最后保障 | 总有数据 |

### 实施路线图

#### 第一阶段：紧急修复 + 基础多数据源（1-2周）
1. **修复AKShare问题**
   - 升级AKShare测试最新版本
   - 如果修复，恢复为主要数据源

2. **集成Tushare备用**
   - 注册Tushare Pro免费账户
   - 实现TushareDataSource基础功能
   - 测试期货数据获取

3. **实现基础降级逻辑**
   - 添加数据源管理器雏形
   - AKShare失败时自动切换Tushare

#### 第二阶段：完善多数据源体系（2-4周）
1. **健康检查机制**
   - 各数据源成功率统计
   - 自动禁用故障数据源
   - 定时恢复检查

2. **数据质量监控**
   - 价格异常检测
   - 数据延迟监控
   - 跨数据源一致性校验

#### 第三阶段：高级功能（4-8周）
1. **智能数据源选择**
   - 基于历史成功率的动态优先级
   - 时间敏感型数据源调度
   - 成本优化调度

2. **数据缓存和聚合**
   - 高频数据本地缓存
   - 多数据源数据聚合
   - 历史数据回填

### 成本效益分析

#### 推荐成本方案：
1. **起步阶段**：AKShare（主） + Tushare免费版（备）
2. **成长阶段**：AKShare + Tushare专业版（期货专享）
3. **成熟阶段**：多数据源 + 自建数据缓存

### 实施建议

#### 推荐方案：**渐进式多数据源架构**

**第一步（立即执行）：**
1. 测试AKShare最新版本（最快修复路径）
2. 注册Tushare Pro免费账户备用
3. 设计数据源抽象接口

**第二步（1周内）：**
1. 实现Tushare基础数据获取
2. 添加简单降级逻辑（AKShare失败→Tushare）
3. 数据源基础健康检查

**第三步（2-4周）：**
1. 完整多数据源管理器
2. 数据质量验证系统
3. 监控和告警基础

---

## 第三部分：会议决议与行动计划

### 会议决议

1. **优先级确认**：AKShare数据源问题为最高优先级，立即解决
2. **架构方向**：采用渐进式多数据源架构，消除单点依赖
3. **实施路径**：先解决当前问题，再建立长期架构
4. **资源分配**：后端团队主导实施，其他团队配合

### 行动计划

#### 短期行动（本周内）：
- [ ] 测试AKShare最新版本是否修复Bug
- [ ] 注册Tushare Pro免费账户
- [ ] 设计数据源抽象层接口
- [ ] 创建多数据源架构技术设计文档

#### 中期行动（2周内）：
- [ ] 实现Tushare数据源集成
- [ ] 实现基础降级逻辑
- [ ] 添加数据源健康检查
- [ ] 验证多数据源方案有效性

#### 长期行动（1个月内）：
- [ ] 完善数据质量监控
- [ ] 实现智能数据源选择
- [ ] 添加数据缓存机制
- [ ] 建立完整的监控告警

### 下一步工作

**负责人：** 后端开发团队
**时间节点：**
- 2月25日：完成AKShare升级测试和Tushare注册
- 2月26日：完成数据源抽象层设计
- 2月27日：实现Tushare基础集成
- 2月28日：完成降级逻辑和初步测试

**风险控制：**
1. 每日进度同步
2. 测试环境充分验证
3. 保留回滚方案

---

## 附录

### 相关文件
1. `ARCHITECTURE.md` - 项目架构文档
2. `plan.md` - 开发计划文档
3. `scripts/debug_futures_api.py` - 期货API调试脚本
4. `scripts/test_alternative_futures_api.py` - 替代API测试脚本
5. `backend/services/finance_crawler.py` - 金融数据爬虫模块

### 技术参考
- AKShare文档：https://akshare.akfamily.xyz/
- Tushare Pro文档：https://tushare.pro/document/2
- FastAPI文档：https://fastapi.tiangolo.com/
- SQLAlchemy文档：https://docs.sqlalchemy.org/

---

**会议记录人：** ARCH（架构师）
**签发日期：** 2026-02-24
**下次会议时间：** 2026-03-03（周一）
**会议主题：** 多数据源架构实施进展评审